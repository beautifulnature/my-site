---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import DocsLayout from '../../../layouts/Docs.astro';
import ResourceDetailArticle from '../../../components/ResourceDetailArticle.astro';
import MoreItemsGrid from '../../../components/MoreItemsGrid.astro';
import MoreItemCard from '../../../components/MoreItemCard.astro';
import {
  buildDetailPageMeta,
  buildStaticPathsForCollection,
} from '../../../utils/content';
import type { EventEntry } from '../../../types/collections';
import { RESOURCE_TYPES } from '../../../utils/resourceTypes';

export const getStaticPaths: GetStaticPaths = async () => {
  const events = await getCollection('events');
  return buildStaticPathsForCollection(events, 'event');
};

const { event } = Astro.props as { event: EventEntry };
const { Content } = await event.render();
const resourceType = RESOURCE_TYPES.events;

const allEvents = await getCollection('events');
const {
  pageUrl,
  moreItems: moreEvents,
  tags: eventTags,
} = buildDetailPageMeta(allEvents, event, resourceType.detailBasePath, Astro.request?.url, 3);
---

<DocsLayout>
  <ResourceDetailArticle
    backHref={resourceType.backHref}
    backLabel={resourceType.backLabel}
    iconName={resourceType.iconName}
    pageUrl={pageUrl}
    shareTitle={event.data.title}
    articleClass="prose blog-prose text-slate-900"
    metaRowClass="text-xs text-black"
  >
    <Fragment slot="meta">
      <span>{event.data.date.toLocaleDateString()}</span>

      {event.data.location && (
        <>
          <span class="h-1 w-1 rounded-full bg-slate-600" />
          <span>{event.data.location}</span>
        </>
      )}

      {event.data.url && (
        <>
          <span class="h-1 w-1 rounded-full bg-slate-600" />
          <a
            href={event.data.url}
            target="_blank"
            rel="noreferrer"
            class="underline hover:text-[var(--scheme-accent)]"
          >
            Registration
          </a>
        </>
      )}
      {eventTags.length > 0 && (
        <>
          <span class="h-1 w-1 rounded-full bg-[var(--scheme-accent)]" />
          <span class="flex flex-wrap gap-1">
            {eventTags.map((tag) => (
              <span class="tag-chip text-[10px]">
                {tag}
              </span>
            ))}
          </span>
        </>
      )}
    </Fragment>

    <Content />
  </ResourceDetailArticle>

  {/* More events â€“ OUTSIDE article */}
  {moreEvents.length > 0 && (
    <MoreItemsGrid title={resourceType.moreTitle} gridId="more-events-grid">
        {moreEvents.map((e) => (
          <MoreItemCard
            href={`${resourceType.detailBasePath}/${e.slug}/`}
            title={e.data.title}
            dateText={e.data.date.toLocaleDateString()}
            dateClass="meta-label text-slate-600"
            titleClass="font-semibold text-slate-900"
            secondaryText={e.data.location}
            secondaryClass="text-slate-600"
          />
        ))}
    </MoreItemsGrid>
  )}
</DocsLayout>