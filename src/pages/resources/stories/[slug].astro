---
import type { GetStaticPaths } from 'astro';
import DocsLayout from '../../../layouts/Docs.astro';
import ResourceDetailArticle from '../../../components/ResourceDetailArticle.astro';
import MoreItemsGrid from '../../../components/MoreItemsGrid.astro';
import MoreItemCard from '../../../components/MoreItemCard.astro';
import {
  buildMoreItemCardProps,
  buildDetailPageMetaFromCollection,
  buildStaticPathsFromCollection,
} from '../../../utils/content';
import type { StoryEntry } from '../../../types/collections';
import { RESOURCE_TYPES } from '../../../utils/resourceTypes';

export const getStaticPaths: GetStaticPaths = async () => {
  return buildStaticPathsFromCollection('stories', 'story');
};

const { story } = Astro.props as { story: StoryEntry };
const { Content } = await story.render();
const resourceType = RESOURCE_TYPES.stories;

const {
  pageUrl,
  moreItems: moreStories,
  tags: storyTags,
} = await buildDetailPageMetaFromCollection('stories', story, resourceType.detailBasePath, Astro.request?.url, 3);
---

<DocsLayout>
  <ResourceDetailArticle
    backHref={resourceType.backHref}
    backLabel={resourceType.backLabel}
    iconName={resourceType.iconName}
    pageUrl={pageUrl}
    shareTitle={story.data.title}
    articleClass="prose blog-prose text-slate-900"
    metaRowClass="text-xs text-slate-900"
  >
    <Fragment slot="meta">
      <div class="flex flex-col gap-1">
        <p class="text-xs">
          {story.data.date.toLocaleDateString()}
          {story.data.industry ? ` · ${story.data.industry}` : ''}
        </p>
        <p class="text-sm">
          {story.data.customer}
        </p>
        {storyTags.length > 0 && (
          <span class="flex flex-wrap gap-1 mt-1">
            {storyTags.map((tag) => (
              <span class="tag-chip text-[10px]">
                {tag}
              </span>
            ))}
          </span>
        )}
      </div>
    </Fragment>

    <Content />
  </ResourceDetailArticle>

  {/* More stories – OUTSIDE article */}
  {moreStories.length > 0 && (
    <MoreItemsGrid title={resourceType.moreTitle} gridId="more-stories-grid">
        {moreStories.map((s) => (
          <MoreItemCard {...buildMoreItemCardProps(s, resourceType.detailBasePath, resourceType.moreCard)} />
        ))}
    </MoreItemsGrid>
  )}
</DocsLayout>
