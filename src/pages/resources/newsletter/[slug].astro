---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import DocsLayout from '../../../layouts/Docs.astro';
import ResourceDetailArticle from '../../../components/ResourceDetailArticle.astro';
import MoreItemsGrid from '../../../components/MoreItemsGrid.astro';
import MoreItemCard from '../../../components/MoreItemCard.astro';
import {
  buildPageUrl,
  getRelatedItems,
  getRequestOrigin,
  getStringTags,
} from '../../../utils/content';
import type { NewsletterEntry } from '../../../types/collections';
import {
  COLOR_BORDER_CARD,
  COLOR_PRIMARY,
  COLOR_TEXT,
  COLOR_TEXT_LIGHT,
} from '../../../utils/colors';
import { RESOURCE_TYPES } from '../../../utils/resourceTypes';

export const getStaticPaths: GetStaticPaths = async () => {
  const issues = await getCollection('newsletter');
  return issues.map((issue) => ({
    params: { slug: issue.slug },
    props: { issue },
  }));
};

const { issue } = Astro.props as { issue: NewsletterEntry };
const { Content } = await issue.render();
const resourceType = RESOURCE_TYPES.newsletter;

const origin = getRequestOrigin(Astro.request?.url);
const pageUrl = buildPageUrl(origin, `${resourceType.detailBasePath}/${issue.slug}/`);
const moreNewsletters = getRelatedItems(await getCollection('newsletter'), issue.slug, 3);
const issueTags = getStringTags(issue.data.tags);
---

<DocsLayout enableToc={true}>
  <ResourceDetailArticle
    backHref={resourceType.backHref}
    backLabel={resourceType.backLabel}
    iconName={resourceType.iconName}
    pageUrl={pageUrl}
    shareTitle={issue.data.title}
    articleClass="prose blog-prose"
    articleId="article-root"
  >
    <Fragment slot="meta">
      <span>
        {issue.data.date.toLocaleDateString()}
        {issue.data.issue ? ` · ${issue.data.issue}` : ''}
      </span>
      {issueTags.length > 0 && (
        <span class="flex flex-wrap gap-1 mt-1">
          {issueTags.map((tag) => (
            <span class="tag-chip">
              {tag}
            </span>
          ))}
        </span>
      )}
    </Fragment>

    <Content />
  </ResourceDetailArticle>

  {/* More newsletters – OUTSIDE article */}
  {moreNewsletters.length > 0 && (
    <MoreItemsGrid title={resourceType.moreTitle} accentColor={COLOR_PRIMARY} gridId="more-newsletters-grid">
        {moreNewsletters.map((n) => (
          <MoreItemCard
            href={`${resourceType.detailBasePath}/${n.slug}/`}
            title={n.data.title}
            dateText={n.data.date.toLocaleDateString()}
            borderColor={COLOR_BORDER_CARD}
            hoverBorderColor={COLOR_PRIMARY}
            dateStyle={`color: ${COLOR_TEXT_LIGHT};`}
            titleStyle={`color: ${COLOR_TEXT};`}
            secondaryText={n.data.issue}
            secondaryStyle={`color: ${COLOR_TEXT_LIGHT};`}
          />
        ))}
    </MoreItemsGrid>
  )}
</DocsLayout>
