---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import DocsLayout from '../../../layouts/Docs.astro';
import ResourceDetailArticle from '../../../components/ResourceDetailArticle.astro';
import MoreItemsGrid from '../../../components/MoreItemsGrid.astro';
import MoreItemCard from '../../../components/MoreItemCard.astro';
import {
  buildPageUrl,
  getRelatedItems,
  getRequestOrigin,
  getStringTags,
} from '../../../utils/content';
import type { VideoEntry } from '../../../types/collections';
import {
  COLOR_BORDER_CARD,
  COLOR_PRIMARY,
  COLOR_TEXT,
} from '../../../utils/colors';
import { RESOURCE_TYPES } from '../../../utils/resourceTypes';

export const getStaticPaths: GetStaticPaths = async () => {
  const videos = await getCollection('videos');
  return videos.map((video) => ({
    params: { slug: video.slug },
    props: { video },
  }));
};

const { video } = Astro.props as { video: VideoEntry };
const { Content } = await video.render();
const resourceType = RESOURCE_TYPES.videos;

const origin = getRequestOrigin(Astro.request?.url);
const pageUrl = buildPageUrl(origin, `${resourceType.detailBasePath}/${video.slug}/`);
const moreVideos = getRelatedItems(await getCollection('videos'), video.slug, 3);
const videoTags = getStringTags(video.data.tags);
---

<DocsLayout>
  <ResourceDetailArticle
    backHref={resourceType.backHref}
    backLabel={resourceType.backLabel}
    iconName={resourceType.iconName}
    iconSize={32}
    pageUrl={pageUrl}
    shareTitle={video.data.title}
    articleClass="prose blog-prose text-slate-900"
    metaRowClass="text-xs"
    metaRowStyle={`color: ${COLOR_TEXT};`}
  >
    <Fragment slot="meta">
      <span>{video.data.date.toLocaleDateString()}</span>
      {video.data.length && (
        <>
          <span class="h-1 w-1 rounded-full bg-[${COLOR_TEXT}]" />
          <span>{video.data.length}</span>
        </>
      )}
      {videoTags.length > 0 && (
        <>
          <span class="h-1 w-1 rounded-full bg-[${COLOR_PRIMARY}]" />
          <span class="flex flex-wrap gap-1">
            {videoTags.map((tag) => (
              <span class="tag-chip text-[10px]" style={`border-color: ${COLOR_PRIMARY}; color: ${COLOR_PRIMARY};`}>
                {tag}
              </span>
            ))}
          </span>
        </>
      )}
    </Fragment>

    {/* responsive YouTube embed */}
    {video.data.youtubeId && (
      <div class="mb-6 overflow-hidden rounded-xl border border-slate-200 bg-slate-50">
        <div class="aspect-video">
          <iframe
            class="h-full w-full"
            src={`https://www.youtube.com/embed/${video.data.youtubeId}`}
            title={video.data.title}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          />
        </div>
      </div>
    )}

    <Content />
  </ResourceDetailArticle>

  {/* More videos â€“ OUTSIDE article, similar pattern to blog */}
  {moreVideos.length > 0 && (
    <MoreItemsGrid title={resourceType.moreTitle} accentColor={COLOR_PRIMARY} gridId="more-videos-grid">
        {moreVideos.map((v) => (
          <MoreItemCard
            href={`${resourceType.detailBasePath}/${v.slug}/`}
            title={v.data.title}
            dateText={v.data.date.toLocaleDateString()}
            borderColor={COLOR_BORDER_CARD}
            hoverBorderColor={COLOR_PRIMARY}
            dateClass="meta-label text-[11px]"
            dateStyle={`color: ${COLOR_TEXT};`}
            titleClass="text-sm font-semibold"
            titleStyle={`color: ${COLOR_TEXT};`}
            secondaryText={v.data.length}
            secondaryClass="text-xs"
            secondaryStyle={`color: ${COLOR_TEXT};`}
          />
        ))}
    </MoreItemsGrid>
  )}
</DocsLayout>