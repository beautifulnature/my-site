---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import DocsLayout from '../../layouts/Docs.astro';
import ResourceDetailArticle from '../../components/ResourceDetailArticle.astro';
import MoreItemsGrid from '../../components/MoreItemsGrid.astro';
import MoreItemCard from '../../components/MoreItemCard.astro';
import {
  buildPageUrl,
  getRelatedItems,
  getRequestOrigin,
  getStringTags,
} from '../../utils/content';
import type { BlogEntry } from '../../types/collections';
import {
  COLOR_BORDER_CARD,
  COLOR_PRIMARY,
  COLOR_TEXT,
  COLOR_TEXT_LIGHT,
} from '../../utils/colors';
import { RESOURCE_TYPES } from '../../utils/resourceTypes';

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
};

const { post } = Astro.props as { post: BlogEntry };
const { Content } = await post.render();
const resourceType = RESOURCE_TYPES.blog;

const origin = getRequestOrigin(Astro.request?.url);
const pageUrl = buildPageUrl(origin, `${resourceType.detailBasePath}/${post.slug}/`);
const morePosts = getRelatedItems(await getCollection('blog'), post.slug, 3);
const postTags = getStringTags(post.data.tags);
---

<DocsLayout enableToc={true}>
  {/* Main article: TOC reads only from here */}
  <ResourceDetailArticle
    backHref={resourceType.backHref}
    backLabel={resourceType.backLabel}
    iconName={resourceType.iconName}
    iconSize={32}
    pageUrl={pageUrl}
    shareTitle={post.data.title}
    articleClass="prose blog-prose"
    articleId="article-root"
  >
    {post.data.description && (
      <div slot="preMeta" class="mb-4">
        <p>
          {post.data.description}
        </p>
      </div>
    )}

    <Fragment slot="meta">
      <span>{post.data.date.toLocaleDateString()}</span>
      <span class="h-1 w-1 rounded-full bg-[var(--scheme-accent)]" />
      <span>
        By{' '}
        {post.data.authorUrl ? (
          <a
            href={post.data.authorUrl}
            class="underline hover:text-[var(--scheme-accent)]"
            target="_blank"
            rel="noreferrer"
          >
            {post.data.author}
          </a>
        ) : (
          post.data.author
        )}
      </span>
      {postTags.length > 0 && (
        <>
          <span class="h-1 w-1 rounded-full bg-[var(--scheme-accent)]" />
          <span class="flex flex-wrap gap-1">
            {postTags.map((tag) => (
              <span class="tag-chip">
                {tag}
              </span>
            ))}
          </span>
        </>
      )}
    </Fragment>

    {/* Main content – headings here are used for TOC */}
    <Content />
  </ResourceDetailArticle>

  {/* More posts – OUTSIDE article-root, ignored by TOC */}
  {morePosts.length > 0 && (
    <MoreItemsGrid title={resourceType.moreTitle} accentColor={COLOR_PRIMARY} gridId="more-blog-grid">
          {morePosts.map((p) => (
            <MoreItemCard
              href={`${resourceType.detailBasePath}/${p.slug}/`}
              title={p.data.title}
              dateText={p.data.date.toLocaleDateString()}
              borderColor={COLOR_BORDER_CARD}
              hoverBorderColor={COLOR_PRIMARY}
              dateStyle={`color: ${COLOR_TEXT_LIGHT};`}
              titleStyle={`color: ${COLOR_TEXT};`}
              description={p.data.description}
              descriptionClass="line-clamp-3"
              descriptionStyle="color: #334155;"
            />
          ))}
    </MoreItemsGrid>
  )}

  {/* DocsTocScript is included by the layout; avoid duplicate inclusion here */}
</DocsLayout>
