---
import { getCollection } from 'astro:content';
import DocsLayout from '../../layouts/Docs.astro';
import DocsTocScript from '../../components/DocsTocScript.astro';
import ShareBar from '../../components/ShareBar.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Build origin + page URL for sharing
const origin = Astro.request?.url ? new URL(Astro.request.url).origin : '';
const pageUrl = origin
  ? `${origin}/blog/${post.slug}/`
  : `/blog/${post.slug}/`;

// Get all posts, sorted newest → oldest
const allPosts = (await getCollection('blog')).sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);

// Find current index
const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);

// Take next 3 posts after current one (older posts)
const morePosts =
  currentIndex === -1 ? [] : allPosts.slice(currentIndex + 1, currentIndex + 4);
---

<DocsLayout title={post.data.title} enableToc={true}>
  {/* Main article: TOC reads only from here */}
  <article class="prose prose-invert max-w-none" id="article-root">
    {/* Top row: description + Blog button */}
    <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
      {post.data.description && (
        <p class="m-0 text-sm text-slate-300 md:text-base">
          {post.data.description}
        </p>
      )}

      <a
        href="/blog"
        class="order-first inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900/60 px-4 py-1.5 text-xs font-medium text-slate-100 shadow-sm hover:border-sky-500 hover:text-sky-300 md:order-none"
      >
        <span class="flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/10 text-sky-300">
          {/* icon */}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            class="h-3 w-3"
            fill="none"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M4 4h12v16H4z" />
            <path d="M16 4h1a3 3 0 0 1 3 3v11h-4" />
            <path d="M8 8h4" />
          </svg>
        </span>
        <span>Blog</span>
      </a>
    </div>

    {/* Meta + share */}
    <div class="mt-2 mb-6 flex flex-wrap items-center justify-between gap-3 text-xs text-slate-400">
      <div class="flex flex-wrap items-center gap-3">
        <span>{post.data.date.toLocaleDateString()}</span>
        <span class="h-1 w-1 rounded-full bg-slate-600" />
        <span>
          By{' '}
          {post.data.authorUrl ? (
            <a
              href={post.data.authorUrl}
              class="underline hover:text-sky-300"
              target="_blank"
              rel="noreferrer"
            >
              {post.data.author}
            </a>
          ) : (
            post.data.author
          )}
        </span>
        {post.data.tags && post.data.tags.length > 0 && (
          <>
            <span class="h-1 w-1 rounded-full bg-slate-600" />
            <span class="flex flex-wrap gap-1">
              {post.data.tags.map((tag) => (
                <span class="rounded-full border border-slate-700 px-2 py-0.5 text-[10px] uppercase tracking-wide">
                  {tag}
                </span>
              ))}
            </span>
          </>
        )}
      </div>

      <ShareBar url={pageUrl} title={post.data.title} />
    </div>

    {/* Main content – headings here are used for TOC */}
    <Content />
  </article>

  {/* More posts – OUTSIDE article-root, ignored by TOC */}
  {morePosts.length > 0 && (
    <section class="mt-12 border-t border-slate-800 pt-6" data-toc-exclude>
      <h2 class="mb-4 text-sm font-semibold uppercase tracking-wide text-slate-400">
        More from the blog
      </h2>
      <div class="grid gap-4 md:grid-cols-3">
        {morePosts.map((p) => (
          <a
            href={`/blog/${p.slug}/`}
            class="flex flex-col rounded-xl border border-slate-800 bg-slate-900/60 p-4 hover:border-sky-500"
          >
            <p class="mb-1 text-[11px] uppercase tracking-wide text-slate-500">
              {p.data.date.toLocaleDateString()}
            </p>
            <h3 class="text-sm font-semibold text-slate-50">
              {p.data.title}
            </h3>
            {p.data.description && (
              <p class="mt-2 line-clamp-3 text-xs text-slate-400">
                {p.data.description}
              </p>
            )}
          </a>
        ))}
      </div>
    </section>
  )}

  {/* Right nav TOC container under "On this page" */}
  <aside class="hidden lg:block">
    <div
      id="article-toc"
      class="hidden sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto text-sm text-slate-300"
    >
      <h2 class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-400">
        On this page
      </h2>
      <ul id="article-toc-list" class="space-y-1"></ul>
    </div>
  </aside>

  {/* Script that builds TOC + t+r toggle */}
  <DocsTocScript enableToc={true} client:load />
</DocsLayout>
