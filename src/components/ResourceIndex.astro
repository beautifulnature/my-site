---
import type { ResourceItem } from '../types/content';
import { getStringTags } from '../utils/content';

const {
  items = [],
  dateField = 'date',
  metaField,
  metaLabel,
  titleField = 'title',
  subtitleField,
  showBody = false,
  isHeroLinkExternal = false,
  heroExternalUrlField,
  selectedTagOverride,
  tagBasePath,
  tagAllPath,
} = Astro.props as {
  items: ResourceItem[];
  dateField?: string;
  metaField?: string;
  metaLabel?: string;
  titleField?: string;
  subtitleField?: string;
  showBody?: boolean;
  isHeroLinkExternal?: boolean;
  heroExternalUrlField?: string;
  selectedTagOverride?: string;
  tagBasePath?: string;
  tagAllPath?: string;
};

const normalizeTag = (tag: string) => tag.trim().toLowerCase();

const selectedTag = (selectedTagOverride ?? decodeURIComponent(Astro.url.searchParams.get('tag') || ''))
  .trim()
  .toLowerCase();

const buildTagHref = (tag?: string) => {
  if (tagBasePath) {
    if (!tag) return tagAllPath || tagBasePath.replace(/\/tag\/?$/, '');
    return `${tagBasePath.replace(/\/$/, '')}/${encodeURIComponent(normalizeTag(tag))}`;
  }
  const params = new URLSearchParams(Astro.url.searchParams);
  if (tag) params.set('tag', normalizeTag(tag));
  else params.delete('tag');
  const qs = params.toString();
  return qs ? `${Astro.url.pathname}?${qs}` : Astro.url.pathname;
};

const getTags = (item: ResourceItem): string[] => getStringTags(item.data.tags);

const allTags = Array.from(new Set(items.flatMap(getTags)));

const filteredItems = selectedTag
  ? items.filter(item =>
      getTags(item).some((tag) => normalizeTag(tag) === selectedTag)
    )
  : items;

const [latestFiltered, ...restFiltered] = filteredItems.length > 0 ? filteredItems : [];

if (!items.length) {
  throw new Error('ResourceIndex: items is empty');
}

import ResourceIcons from './ResourceIcons.astro';

const getIconName = () => {
  const path = Astro.url.pathname;
  if (path.startsWith('/blog')) return 'blog';
  if (path.startsWith('/resources/videos')) return 'videos';
  if (path.startsWith('/resources/stories')) return 'stories';
  if (path.startsWith('/resources/events')) return 'events';
  if (path.startsWith('/resources/press')) return 'press';
  if (path.startsWith('/resources/newsletter')) return 'newsletter';
  return 'blog';
};

const iconName = getIconName();
const isVideosPath = Astro.url.pathname.startsWith('/resources/videos');

const extractYouTubeId = (item: ResourceItem) => {
  const directId = item.data.youtubeId;
  if (typeof directId === 'string' && directId.trim()) return directId.trim();

  const rawUrl = item.data.url;
  if (typeof rawUrl !== 'string' || !rawUrl.trim()) return '';

  try {
    const parsed = new URL(rawUrl);
    if (parsed.hostname.includes('youtu.be')) {
      return parsed.pathname.replace(/^\//, '').trim();
    }
    if (parsed.hostname.includes('youtube.com')) {
      const fromQuery = parsed.searchParams.get('v');
      if (fromQuery) return fromQuery.trim();
      const pathParts = parsed.pathname.split('/').filter(Boolean);
      const markerIndex = pathParts.findIndex((part) => part === 'embed' || part === 'shorts');
      if (markerIndex >= 0 && pathParts[markerIndex + 1]) return pathParts[markerIndex + 1].trim();
    }
  } catch {
    return '';
  }

  return '';
};

const getYouTubeThumbnail = (item: ResourceItem) => {
  const youtubeId = extractYouTubeId(item);
  return youtubeId ? `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg` : '';
};

const latestThumbnailUrl = latestFiltered && isVideosPath
  ? getYouTubeThumbnail(latestFiltered)
  : '';

const formatMeta = (item: ResourceItem) => {
  if (!metaField) return '';
  const v = item.data[metaField];
  if (!v) return '';
  if (metaLabel) return ` · ${metaLabel}: ${v}`;
  return ` · ${v}`;
};

const getItemHref = (item: ResourceItem) => {
  if (isHeroLinkExternal && heroExternalUrlField && item.data[heroExternalUrlField]) {
    return String(item.data[heroExternalUrlField]);
  }
  const basePath = Astro.url.pathname.replace(/\/tag\/[^/]+$/, '').replace(/\/$/, '');
  return `${basePath}/${item.slug}`;
};

const formatDate = (item: ResourceItem) => {
  const v = item.data[dateField];
  if (!v) return '';
  if (!(v instanceof Date) && typeof v !== 'string' && typeof v !== 'number') {
    return String(v);
  }
  const d = v instanceof Date ? v : new Date(v);
  return isNaN(d.getTime())
    ? String(v)
    : d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
};
---

{allTags.length > 0 && (
  <div class="flex flex-wrap gap-2 mb-6">
    <a
      class={`rounded-full border px-3 py-1 text-xs uppercase tracking-wide transition-colors ${!selectedTag ? 'bg-[var(--scheme-accent)] text-white border-[var(--scheme-accent)]' : 'border-[var(--scheme-accent)] text-[var(--scheme-accent)] bg-white hover:bg-[var(--scheme-accent)] hover:text-white'}`}
      href={buildTagHref()}
    >
      All
    </a>

    {allTags.map(tag => (
      <a
        class={`rounded-full border px-3 py-1 text-xs uppercase tracking-wide transition-colors ${selectedTag === normalizeTag(tag) ? 'bg-[var(--scheme-accent)] text-white border-[var(--scheme-accent)]' : 'border-[var(--scheme-accent)] text-[var(--scheme-accent)] bg-white hover:bg-[var(--scheme-accent)] hover:text-white'}`}
        href={buildTagHref(tag)}
      >
        {tag}
      </a>
    ))}
  </div>
)}

{latestFiltered ? (
  <article class={isVideosPath ? 'c-link-card c-link-card--horizontal c-link-card--media mb-10 border border-[var(--scheme-border)]' : 'mb-10 rounded-2xl border p-6'}>
    {latestThumbnailUrl && (
      <a
        href={getItemHref(latestFiltered)}
        target={isHeroLinkExternal ? '_blank' : undefined}
        rel={isHeroLinkExternal ? 'noreferrer' : undefined}
        class={isVideosPath ? 'c-link-card__header mb-4' : 'resource-video-thumb mb-4'}
      >
        {isVideosPath ? (
          <span class="c-link-card__media">
            <img
              src={latestThumbnailUrl}
              alt={`YouTube thumbnail for ${latestFiltered.data[titleField]}`}
              class="c-picture__image h-full w-full object-cover"
              loading="lazy"
            />
          </span>
        ) : (
          <img
            src={latestThumbnailUrl}
            alt={`YouTube thumbnail for ${latestFiltered.data[titleField]}`}
            class="resource-video-thumb-img"
            loading="lazy"
          />
        )}
      </a>
    )}

    <div class={isVideosPath ? 'px-4 pt-4 text-sm text-slate-600' : 'mb-3 flex items-center gap-2 text-sm text-slate-600'}>
      {(!isVideosPath || !latestThumbnailUrl) && <ResourceIcons name={iconName} />}
      <span>{formatDate(latestFiltered)}{formatMeta(latestFiltered)}</span>
    </div>

    <h2 class={isVideosPath ? 'px-4 pb-4 text-2xl font-semibold' : 'text-2xl font-semibold'}>
      <a
        href={getItemHref(latestFiltered)}
        target={isHeroLinkExternal ? '_blank' : undefined}
        rel={isHeroLinkExternal ? 'noreferrer' : undefined}
        class="hover:underline"
      >
        {latestFiltered.data[titleField]}
      </a>
    </h2>

    {subtitleField && latestFiltered.data[subtitleField] && (
      <p class={isVideosPath ? 'px-4 pb-4 text-slate-600' : 'text-slate-600'}>{latestFiltered.data[subtitleField]}</p>
    )}

    {showBody && latestFiltered.body && (
      <div class="prose max-w-none" set:html={latestFiltered.body} />
    )}
  </article>
) : (
  <p class="text-sm text-slate-600">No items match this tag.</p>
)}

<section aria-label="More items">
  <div class="grid gap-6 md:grid-cols-2">
    {restFiltered.map((item) => {
      const itemThumbnailUrl = isVideosPath ? getYouTubeThumbnail(item) : '';

      return (
      <article class={isVideosPath ? 'c-link-card c-link-card--vertical c-link-card--media border border-[var(--scheme-border)]' : 'rounded-2xl border p-5'}>
        {itemThumbnailUrl && (
          <a
            href={getItemHref(item)}
            class={isVideosPath ? 'c-link-card__header mb-3' : 'resource-video-thumb mb-3'}
          >
            {isVideosPath ? (
              <span class="c-link-card__media">
                <img
                  src={itemThumbnailUrl}
                  alt={`YouTube thumbnail for ${item.data[titleField]}`}
                  class="c-picture__image h-full w-full object-cover"
                  loading="lazy"
                />
              </span>
            ) : (
              <img
                src={itemThumbnailUrl}
                alt={`YouTube thumbnail for ${item.data[titleField]}`}
                class="resource-video-thumb-img"
                loading="lazy"
              />
            )}
          </a>
        )}

        <div class={isVideosPath ? 'px-4 pt-3 text-xs uppercase tracking-wide text-slate-500' : 'mb-2 text-xs uppercase tracking-wide text-slate-500'}>
          {formatDate(item)}{formatMeta(item)}
        </div>

        <h3 class={isVideosPath ? 'px-4 pb-4 text-lg font-semibold' : 'text-lg font-semibold'}>
          <a
            href={getItemHref(item)}
            class="hover:underline"
          >
            {item.data[titleField]}
          </a>
        </h3>

        {subtitleField && item.data[subtitleField] && (
          <p class={isVideosPath ? 'px-4 pb-4 text-slate-600' : 'text-slate-600'}>{item.data[subtitleField]}</p>
        )}
      </article>
    )})}
  </div>
</section>