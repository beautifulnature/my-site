---
import type { ResourceItem } from '../types/content';
import { getStringTags, normalizeTag } from '../utils/content';
import { getYouTubeThumbnailUrl } from '../utils/media';
import TagChipList from './TagChipList.astro';

const {
  items = [],
  dateField = 'date',
  metaField,
  metaLabel,
  titleField = 'title',
  subtitleField,
  showBody = false,
  isHeroLinkExternal = false,
  heroExternalUrlField,
  selectedTagOverride,
  tagBasePath,
  tagAllPath,
} = Astro.props as {
  items: ResourceItem[];
  dateField?: string;
  metaField?: string;
  metaLabel?: string;
  titleField?: string;
  subtitleField?: string;
  showBody?: boolean;
  isHeroLinkExternal?: boolean;
  heroExternalUrlField?: string;
  selectedTagOverride?: string;
  tagBasePath?: string;
  tagAllPath?: string;
};

const selectedTag = normalizeTag(
  selectedTagOverride ?? decodeURIComponent(Astro.url.searchParams.get('tag') || ''),
);

const buildTagHref = (tag?: string) => {
  if (tagBasePath) {
    if (!tag) return tagAllPath || tagBasePath.replace(/\/tag\/?$/, '');
    return `${tagBasePath.replace(/\/$/, '')}/${encodeURIComponent(normalizeTag(tag))}`;
  }
  const params = new URLSearchParams(Astro.url.searchParams);
  if (tag) params.set('tag', normalizeTag(tag));
  else params.delete('tag');
  const qs = params.toString();
  return qs ? `${Astro.url.pathname}?${qs}` : Astro.url.pathname;
};

const getTags = (item: ResourceItem): string[] => getStringTags(item.data.tags);

const allTags = Array.from(new Set(items.flatMap(getTags)));

const mobileTagItems = [
  { label: 'All', href: buildTagHref(), active: !selectedTag },
  ...allTags.map((tag) => ({
    label: tag,
    href: buildTagHref(tag),
    active: selectedTag === normalizeTag(tag),
  })),
];

const desktopTagItems = mobileTagItems;

const filteredItems = selectedTag
  ? items.filter(item =>
      getTags(item).some((tag) => normalizeTag(tag) === selectedTag)
    )
  : items;

const [latestFiltered, ...restFiltered] = filteredItems.length > 0 ? filteredItems : [];

if (!items.length) {
  throw new Error('ResourceIndex: items is empty');
}

import VideoLinkCard from './VideoLinkCard.astro';
import ResourceImageLinkCard from './ResourceImageLinkCard.astro';

const getIconName = () => {
  const path = Astro.url.pathname;
  if (path.startsWith('/blog')) return 'blog';
  if (path.startsWith('/resources/videos')) return 'videos';
  if (path.startsWith('/resources/stories')) return 'stories';
  if (path.startsWith('/resources/events')) return 'events';
  if (path.startsWith('/resources/press')) return 'press';
  if (path.startsWith('/resources/newsletter')) return 'newsletter';
  return 'blog';
};

const iconName = getIconName();
const isVideosPath = Astro.url.pathname.startsWith('/resources/videos');
const isBlogPath = Astro.url.pathname.startsWith('/blog');
const resourceLabel = iconName.charAt(0).toUpperCase() + iconName.slice(1);

const latestThumbnailUrl = latestFiltered && isVideosPath
  ? getYouTubeThumbnailUrl(latestFiltered.data)
  : '';

const formatMeta = (item: ResourceItem) => {
  if (!metaField) return '';
  const v = item.data[metaField];
  if (!v) return '';
  if (metaLabel) return ` · ${metaLabel}: ${v}`;
  return ` · ${v}`;
};

const formatDateMeta = (item: ResourceItem) => `${formatDate(item)}${formatMeta(item)}`;

const getItemHref = (item: ResourceItem) => {
  if (isHeroLinkExternal && heroExternalUrlField && item.data[heroExternalUrlField]) {
    return String(item.data[heroExternalUrlField]);
  }
  const basePath = Astro.url.pathname.replace(/\/tag\/[^/]+$/, '').replace(/\/$/, '');
  return `${basePath}/${item.slug}`;
};

const formatDate = (item: ResourceItem) => {
  const v = item.data[dateField];
  if (!v) return '';
  if (!(v instanceof Date) && typeof v !== 'string' && typeof v !== 'number') {
    return String(v);
  }
  const d = v instanceof Date ? v : new Date(v);
  return isNaN(d.getTime())
    ? String(v)
    : d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
};

const loadMoreInitial = 6;
const loadMoreStep = 6;
const hasMoreItems = restFiltered.length > loadMoreInitial;
---

<div class="col-span-12">
  {allTags.length > 0 && (
    <TagChipList items={mobileTagItems} size="mobile" className="mb-6 flex flex-wrap gap-2 vp9:hidden" />
  )}

  <div class={allTags.length > 0 ? 'vp9:grid vp9:grid-cols-[11.5rem_minmax(0,1fr)] vp9:gap-4' : ''}>
    {allTags.length > 0 && (
      <div class="max-vp9:order-2 max-vp9:border-b vp9:border-r border-solid prop-border pt-8 pb-8 vp9:pr-8">
        <p class="mb-2 text-[10px] font-semibold uppercase tracking-[0.16em] text-slate-500">Tags</p>
        <TagChipList items={desktopTagItems} size="desktop" className="flex flex-wrap gap-1.5" />
      </div>
    )}

    <div class="vp9:p-14">
      {latestFiltered ? (
        isVideosPath ? (
          <div data-load-more-root data-step={String(loadMoreStep)}>
            <section aria-label="Video items" class="mb-10">
              <div class="grid grid-cols-2 gap-8 vp9:gap-20">
                <VideoLinkCard
                  href={getItemHref(latestFiltered)}
                  title={String(latestFiltered.data[titleField])}
                  thumbnailUrl={latestThumbnailUrl}
                  dateText={formatDateMeta(latestFiltered)}
                  subtitle={subtitleField ? String(latestFiltered.data[subtitleField] ?? '') : undefined}
                  headingLevel="h2"
                  spanTwoCols={true}
                  target={isHeroLinkExternal ? '_blank' : undefined}
                  rel={isHeroLinkExternal ? 'noreferrer' : undefined}
                />

                {restFiltered.map((item, index) => {
                  const itemThumbnailUrl = getYouTubeThumbnailUrl(item.data);

                  return (
                    <div class="js-load-more-item" hidden={index >= loadMoreInitial}>
                      <VideoLinkCard
                        href={getItemHref(item)}
                        title={String(item.data[titleField])}
                        thumbnailUrl={itemThumbnailUrl}
                        dateText={formatDateMeta(item)}
                        subtitle={subtitleField ? String(item.data[subtitleField] ?? '') : undefined}
                      />
                    </div>
                  );
                })}
              </div>
            </section>

            {hasMoreItems && (
              <div class="mb-10 mt-4 flex justify-center">
                <button
                  type="button"
                  class="js-load-more-btn rounded-full border border-slate-300 bg-white px-6 py-3 text-slate-700 transition hover:border-slate-400 hover:text-slate-900"
                >
                  Load more
                </button>
              </div>
            )}
          </div>
        ) : (
          <div data-load-more-root data-step={String(loadMoreStep)}>
            <section
              aria-label={`${resourceLabel} items`}
              class={`mb-10 ${isBlogPath ? 'resource-index-section--blog' : ''}`}
            >
              <div class="grid grid-cols-2 gap-8 vp9:gap-20">
                <ResourceImageLinkCard
                  href={getItemHref(latestFiltered)}
                  title={String(latestFiltered.data[titleField])}
                  label={resourceLabel}
                  dateText={formatDateMeta(latestFiltered)}
                  detailText={subtitleField ? String(latestFiltered.data[subtitleField] ?? '') : undefined}
                  headingLevel="h2"
                  spanTwoCols={true}
                  target={isHeroLinkExternal ? '_blank' : undefined}
                  rel={isHeroLinkExternal ? 'noreferrer' : undefined}
                />

                {showBody && latestFiltered.body && (
                  <div class="vp7:col-span-2 prose max-w-none" set:html={latestFiltered.body} />
                )}

                {restFiltered.map((item, index) => {
                  return (
                    <div class="js-load-more-item" hidden={index >= loadMoreInitial}>
                      <ResourceImageLinkCard
                        href={getItemHref(item)}
                        title={String(item.data[titleField])}
                        label={resourceLabel}
                        dateText={formatDateMeta(item)}
                        detailText={subtitleField ? String(item.data[subtitleField] ?? '') : undefined}
                      />
                    </div>
                  );
                })}
              </div>
            </section>

            {hasMoreItems && (
              <div class="mb-10 mt-4 flex justify-center">
                <button
                  type="button"
                  class="js-load-more-btn rounded-full border border-slate-300 bg-white px-6 py-3 text-slate-700 transition hover:border-slate-400 hover:text-slate-900"
                >
                  Load more
                </button>
              </div>
            )}
          </div>
        )
      ) : (
        <p class="text-sm text-slate-600">No items match this tag.</p>
      )}
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    if (typeof window === 'undefined') return;

    const roots = document.querySelectorAll('[data-load-more-root]');
    if (!roots.length) return;

    roots.forEach((root) => {
      const items = Array.from(root.querySelectorAll('.js-load-more-item'));
      const button = root.querySelector('.js-load-more-btn');

      if (!(button instanceof HTMLButtonElement) || !items.length) return;

      const step = Number(root.getAttribute('data-step') || '6');
      let visibleCount = items.filter((item) => !item.hasAttribute('hidden')).length;

      const updateButton = () => {
        button.hidden = visibleCount >= items.length;
      };

      button.addEventListener('click', () => {
        const nextVisibleCount = Math.min(visibleCount + step, items.length);
        for (let i = visibleCount; i < nextVisibleCount; i += 1) {
          items[i].removeAttribute('hidden');
        }
        visibleCount = nextVisibleCount;
        updateButton();
      });

      updateButton();
    });
  })();
</script>