---
import "../styles/global.css";
import DocsTocScript from "../components/DocsTocScript.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import GoToTopButton from "../components/GoToTopButton.astro";
import { SIDEBAR_SECTIONS } from "../utils/navigation";
import { SITE_CONTENT } from "../utils/siteContent";

const { title, enableToc = false } = Astro.props;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
  </head>
  <body class="scheme-default" data-aos-easing="ease" data-aos-duration="400" data-aos-delay="0">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:z-[100] focus:rounded-md focus:bg-white focus:px-3 focus:py-2 focus:text-sm focus:font-semibold focus:text-slate-900 focus:shadow-lg"
    >
      Skip to content
    </a>

    <div class="flex flex-col min-h-screen">
    <div
      class="bg-indigo-600 px-4 py-2 text-center text-[11px] font-medium tracking-wide text-white sm:py-2.5 sm:text-xs"
    >
      {SITE_CONTENT.announcement}
      <a href="#intelligence" class="ml-2 underline underline-offset-2"
        >{SITE_CONTENT.announcementLinkLabel}</a
      >
    </div>
    <Header />

    <div class="flex flex-1">
      <!-- LEFT NAV -->
      <aside
        id="sidebar"
        class="w-64 border-r border-slate-800 p-6 vp7:block sidebar-hidden text-black"
      >
        <button
          id="sidebar-toggle-btn"
          class="mb-4 px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 focus:outline-none vp7:hidden"
        >
          Toggle Navigation
        </button>
        <h2 class="text-lg font-semibold">{SITE_CONTENT.sidebarHeading}</h2>

        {SIDEBAR_SECTIONS.map((section) => (
          <div class="mb-6">
            {section.heading && (
              <h3 class="h3-section-label">
                {section.heading}
              </h3>
            )}
            <ul class="space-y-1 text-sm">
              {section.links.map((link) => (
                <li><a href={link.href} class="hover:text-white">{link.label}</a></li>
              ))}
            </ul>
          </div>
        ))}
      </aside>

      <button
        type="button"
        aria-label="Close menu"
        class="fixed inset-0 z-30 hidden bg-slate-900/20 backdrop-blur-[1px] vp9:hidden"
        data-mobile-backdrop></button>

      <main id="main-content" class="flex-1 min-w-0">
        <!-- <div class="layout-container"> -->
          <slot />
        <!-- </div> -->
      </main>

      <!-- MAIN + RIGHT TOC -->
      <!-- <main class="flex flex-1">
        <div class="mx-auto flex-1 max-w-3xl p-6 vp7:p-10">
          <slot />
        </div> -->

      {
        enableToc && (
          <aside
            id="article-toc"
            class="hidden vp12:block w-64 border-l border-slate-800 p-4 text-sm text-black sticky top-16 self-start"
          >
            <h2 class="h2-section-label text-xs font-semibold">
              {SITE_CONTENT.tocHeading}
            </h2>
            <nav>
              <ul id="article-toc-list" class="space-y-1 text-xs" />
            </nav>
          </aside>
        )
      }
    </div>
    </div>

    <DocsTocScript enableToc={enableToc} />
    <script is:inline>
      (() => {
        if (typeof window === "undefined") return;

        const animatedElements = document.querySelectorAll("[data-aos]");
        if (!animatedElements.length) return;

        const applyTimingFromData = (element) => {
          const duration = element.getAttribute("data-aos-duration");
          const delay = element.getAttribute("data-aos-delay");
          const easing = element.getAttribute("data-aos-easing");

          if (duration) element.style.transitionDuration = `${duration}ms`;
          if (delay) element.style.transitionDelay = `${delay}ms`;
          if (easing === "ease-out-expo") {
            element.style.transitionTimingFunction = "cubic-bezier(0.19, 1, 0.22, 1)";
          }
        };

        animatedElements.forEach((element) => {
          element.classList.add("aos-init");
          applyTimingFromData(element);
        });

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (!entry.isIntersecting) return;
              entry.target.classList.add("aos-animate");
              observer.unobserve(entry.target);
            });
          },
          {
            threshold: 0.15,
            rootMargin: "0px 0px -8% 0px",
          },
        );

        animatedElements.forEach((element) => observer.observe(element));
      })();

      (() => {
        if (typeof window === "undefined") return;

        const carousels = document.querySelectorAll(".js-toggle-carousel");
        if (!carousels.length) return;

        carousels.forEach((carousel) => {
          const slides = Array.from(carousel.querySelectorAll(".c-toggle-carousel__slide"));
          const bullets = Array.from(carousel.querySelectorAll(".swiper-pagination-bullet"));
          const prevButton = carousel.querySelector(".c-toggle-carousel__button--prev");
          const nextButton = carousel.querySelector(".c-toggle-carousel__button--next");
          const wrapper = carousel.querySelector(".c-toggle-carousel__wrapper");

          if (!slides.length || !(wrapper instanceof HTMLElement)) return;

          let activeIndex = 0;
          let touchStartX = 0;
          let touchCurrentX = 0;
          let isTouchDragging = false;
          const swipeThresholdPx = 48;

          const setActiveSlide = (index) => {
            activeIndex = Math.max(0, Math.min(index, slides.length - 1));

            slides.forEach((slide, slideIndex) => {
              const isActive = slideIndex === activeIndex;
              slide.classList.toggle("is-active", isActive);
              slide.setAttribute("aria-hidden", isActive ? "false" : "true");
            });

            wrapper.style.transform = `translate3d(-${activeIndex * 100}%, 0, 0)`;

            bullets.forEach((bullet, bulletIndex) => {
              const isActive = bulletIndex === activeIndex;
              bullet.setAttribute("aria-selected", isActive ? "true" : "false");
              bullet.setAttribute("tabindex", isActive ? "0" : "-1");
            });

            if (prevButton instanceof HTMLButtonElement) {
              prevButton.disabled = activeIndex === 0;
            }

            if (nextButton instanceof HTMLButtonElement) {
              nextButton.disabled = activeIndex === slides.length - 1;
            }
          };

          bullets.forEach((bullet, bulletIndex) => {
            bullet.addEventListener("click", () => setActiveSlide(bulletIndex));
          });

          if (prevButton instanceof HTMLButtonElement) {
            prevButton.addEventListener("click", () => setActiveSlide(activeIndex - 1));
          }

          if (nextButton instanceof HTMLButtonElement) {
            nextButton.addEventListener("click", () => setActiveSlide(activeIndex + 1));
          }

          const onTouchStart = (event) => {
            if (event.touches.length !== 1) return;
            touchStartX = event.touches[0].clientX;
            touchCurrentX = touchStartX;
            isTouchDragging = true;
          };

          const onTouchMove = (event) => {
            if (!isTouchDragging || event.touches.length !== 1) return;
            touchCurrentX = event.touches[0].clientX;
          };

          const onTouchEnd = () => {
            if (!isTouchDragging) return;

            const deltaX = touchCurrentX - touchStartX;
            if (Math.abs(deltaX) >= swipeThresholdPx) {
              if (deltaX < 0) {
                setActiveSlide(activeIndex + 1);
              } else {
                setActiveSlide(activeIndex - 1);
              }
            }

            isTouchDragging = false;
          };

          wrapper.addEventListener("touchstart", onTouchStart, { passive: true });
          wrapper.addEventListener("touchmove", onTouchMove, { passive: true });
          wrapper.addEventListener("touchend", onTouchEnd);
          wrapper.addEventListener("touchcancel", onTouchEnd);

          setActiveSlide(activeIndex);
        });
      })();
    </script>
    <GoToTopButton />
    <Footer />
  </body>
</html>
